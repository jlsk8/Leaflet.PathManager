/*
 PathManager v0.1.1, a Javascript plugin for Leaflet
 (c) 2015, Jacques Lorentz
*/
var PathManager=function(){var t,n={pathLayer:null,idPath:0,idArea:0},l=[],a=[],r=function(){var t=function(t){this.id=t,this.animation=0,this.layer=null,this.animInterval=null,this.restrictions=[],this.init=function(t,n){var l=n&&n.positions?n.positions:[];n&&n.animation,this.animation=n&&n.animation?n.animation:0,this.layer=L.polyline(l,{color:"#c0392b",opacity:1,weight:3}),n&&n.style&&this.layer.setStyle(n.style),t.addLayer(this.layer)},this.addPos=function(t,n){clearInterval(this.animInterval),t.lat||(t={lat:t[0],lng:t[1]});for(var l=function(){for(var n=function(t,n){for(var l=!1,a=t.length,r=n.lat,i=n.lng,e=0,s=a-1;a>e;s=e++)(t[e].lat<r&&r<t[s].lat||t[s].lat<r&&r<t[e].lat)&&i<(t[s].lng-t[e].lng)*(r-t[e].lat)/(t[s].lat-t[e].lat)+t[e].lng&&(l=!l);return l},l=e.length-1;l>=0;l--)if(n(e[l],t))return!1;r.addLatLng(t)},r=this.layer,i=[],e=[],s=0;s<this.restrictions.length;s++)for(var h=this.restrictions[s],o=0;o<a.length;o++)a[o].id==h&&e.push(a[o].getPos());if(0==r._latlngs.length)return void l();var g=function(t,n){var l=function(t){for(var n=!1,l=t.lat,a=t.lng,r=0;r<e.length;r++)for(var i=e[r],s=0;s<i.length;s++){var h=s+1;h==i.length&&(h=0),(i[s].lat<l&&i[h].lat>=l||i[h].lat<l&&i[s].lat>=l)&&a>(l-i[s].lat)/(i[h].lat-i[s].lat)*(i[h].lng-i[s].lng)+i[s].lng&&(n=!n)}return n},a=function(t,n){for(var a=t.lng,r=t.lat,i=n.lng-a,s=n.lat-r,h=Math.sqrt(i*i+s*s),o=i/h,g=s/h,f=0;f<e.length;f++)for(var u=e[f],c=0;c<u.length;c++){var v=c+1;v==u.length&&(v=0);var y=u[c].lng-a,d=u[c].lat-r,p=u[v].lng-a,_=u[v].lat-r;if(0==y&&0==d&&p==i&&_==s||0==p&&0==_&&y==i&&d==s)return!0;var L=y*o+d*g,m=d*o-y*g,P=p*o+_*g,w=_*o-p*g;if(0>m&&w>0||0>w&&m>0){var S=L+(P-L)*(0-m)/(w-m);if(S>=0&&h>=S)return!1}}var A={lat:r+s/2,lng:a+i/2};return!l(A)},r=function(t,n){var l=n.lng-t.lng,a=n.lat-t.lat;return Math.sqrt(l*l+a*a)};if(l(t)||l(n))return null;if(a(t,n))return[];for(var i=[t],s=0;s<e.length;s++)i=i.concat(e[s]);i.push(n);var h=1;i[0].totalDist=0;for(var o=0,g=0;g<i.length-1;){for(var f=1/0,s=0;h>s;s++)for(var u=h;u<i.length;u++)if(a(i[s],i[u])){var c=i[s].totalDist+r(i[s],i[u]);f>c&&(f=c,o=s,g=u)}if(f==1/0)return null;i[g].prev=o,i[g].totalDist=f;var v=i[g];i[g]=i[h],i[h]=v,h++}for(var s=h-1,y=[];s>0;)s=i[s].prev,s>0&&y.push({lat:i[s].lat,lng:i[s].lng});return y.reverse(),y},f=r._latlngs[r._latlngs.length-1],u=g(f,t);if(u){i=u.concat(t);var c=function(){1==_[L]&&r.addLatLng({lat:_[L-1].lat,lng:_[L-1].lng}),r._latlngs[r._latlngs.length-1].lat=_[L].lat,r._latlngs[r._latlngs.length-1].lng=_[L].lng,r.redraw(),L++,L==_.length-1&&(clearInterval(m),r._latlngs[r._latlngs.length-1].lat=p.lat,r._latlngs[r._latlngs.length-1].lng=p.lng,r.redraw())},v=function(){for(var t=r._latlngs[r._latlngs.length-1],n=0;n<i.length;n++){for(var l=i[n],a=l.lat?l:{lat:l[0],lng:l[1]},e=[a.lat-t.lat,a.lng-t.lng],s=Math.sqrt(e[0]*e[0]+e[1]*e[1]),h=s/y*10,o=[e[0]/h,e[1]/h],g=0;h-1>g;g++){var f=0==_.length?t:_[_.length-1];1==f&&(f=t);var l={lat:f.lat+o[0],lng:f.lng+o[1]};_.push(l)}_.push(i[n]),_.push(!0),t=i[n]}t=r._latlngs[r._latlngs.length-1],r.addLatLng({lat:t.lat,lng:t.lng});var u=setInterval(c,100);return u},y=n||this.animation;if(0==y)for(var s=0;s<i.length;s++){var d=i[s],p=d.lat?d:{lat:d[0],lng:d[1]};r.addLatLng(p)}else{var _=[],L=0,m=v(),d=i[i.length-1],p=d.lat?d:{lat:d[0],lng:d[1]};this.animInterval=m}}},this.getPos=function(t){var n="undefined"!=typeof this.layer._latlngs[0][0]?this.layer._latlngs[0]:this.layer._latlngs;return t?n[t]:n},this.remove=function(){this.layer.remove()},this.clean=function(){this.layer._latlngs=[],this.layer.redraw()},this.setStyle=function(t){this.layer.setStyle(t)},this.addRestriction=function(t){if("array"==typeof t)for(var n=t.length-1;n>=0;n--)this.restrictions.push(t[n].id);else"undefined"!=typeof t&&this.restrictions.push(t.id)},this.removeRestriction=function(t){if("array"==typeof t)for(var n=t.length-1;n>=0;n--){var l=this.restrictions.indexOf(t[n].id);this.restrictions.splice(l,1)}else if("undefined"!=typeof t){var l=this.restrictions.indexOf(t.id);this.restrictions.splice(l,1)}else this.restrictions=[]},this.getRestrictions=function(){for(var t=[],n=this.restrictions.length-1;n>=0;n--)t.push(a[this.restrictions[n]]);return t}},r=function(t){this.id=t,this.layer=null,this.init=function(t,n){var l=n&&n.positions?n.positions:[];this.layer=L.polygon(l,{color:"#444",opacity:1,weight:2}),n&&n.style&&this.layer.setStyle(n.style),t.addLayer(this.layer)},this.addPos=function(t){this.layer.addLatLng(t)},this.getPos=function(t){var n="undefined"!=typeof this.layer._latlngs[0][0]?this.layer._latlngs[0]:this.layer._latlngs;return t?n[t]:n},this.remove=function(){this.layer.remove()},this.clean=function(){this.layer._latlngs=[],this.layer.redraw()},this.hide=function(){this.layer.setStyle({opacity:0,fillOpacity:0})},this.display=function(){this.layer.setStyle({opacity:1,fillOpacity:.2})},this.setStyle=function(t){this.layer.setStyle(t)}},i=function(t){n.pathLayer=new L.layerGroup,n.pathLayer.addTo(t)},e=function(a){var r=new t(n.idPath++);return r.init(n.pathLayer,a),l.push(r),r},s=function(t){var l=new r(n.idArea++);return l.init(n.pathLayer,t),a.push(l),l},h=function(){return l},o=function(){return a};return{init:i,createPath:e,createArea:s,getAllPaths:h,getAllAreas:o}};return function(){return t||(t=r()),t}}(),P=PathManager();